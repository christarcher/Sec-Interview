### 现在在域外有一台工作组机器的权限但没有域用户且无法直接通过漏洞进入域内，请问这种情况怎么进入域中找到域控

**1. 探索工作组机器与域的关联**

虽然这台机器不属于域，但它可能与域内的资源或用户有业务往来，这些连接就是你的切入点

- **检查 DNS 设置**：查看这台工作组机器的 DNS 服务器地址。如果它指向了域内的 DNS 服务器，那么它很可能与域有信任关系
  - **命令**：`ipconfig /all` 或 `Get-DnsClientServerAddress`
  - **目的**：获取DNS服务器IP，这个IP很可能就是**域控制器（DC）**的IP，因为DC通常也作为域内的DNS服务器
- **查找映射的共享**：检查这台机器是否映射了域内的网络共享（如 \DC\share）
  - **命令**：`net use` 或 `Get-SmbConnection`
  - **目的**：如果存在映射，你可能会找到域用户的凭据缓存，或者在共享中找到敏感文件
- **查看凭据缓存**：这台机器上可能缓存了域用户的登录凭据，这是最重要的突破口
  - **命令**：利用 `mimikatz` 的 `sekurlsa::logonpasswords` 命令来转储内存中的凭据
  - **目的**：如果某个域用户曾用这台工作组机器远程登录过（例如 RDP），或者访问过域内的共享资源，其密码哈希很可能被缓存下来

**2. 利用服务和信任关系**

即使没有找到域用户的凭据，你仍然可以利用工作组机器与域之间的服务信任关系

- **Kerberos 服务票据**：Windows 系统在用户登录后会生成 Kerberos 服务票据（TGT）。虽然这台机器不属于域，但如果一个域用户曾通过它访问过域内服务，那么票据可能被缓存下来
  - **工具**：`mimikatz` 的 `kerberos::list /full` 命令
  - **目的**：获取并导出 Kerberos 票据。有了这些票据，你就可以在不拥有密码哈希的情况下，以该用户的身份访问域内的其他服务
- **SMB 会话**：通过检查这台机器与域内其他机器之间的 SMB 会话，你可以发现更多潜在的攻击路径
  - **命令**：`net session` 或 `Get-SmbSession`
  - **目的**：找到与域内机器建立的会话，这可能表明存在可利用的信任关系

**3. 利用凭据重用进行横向移动**

如果你的信息收集成功，找到了一个域用户的凭据哈希，恭喜你，你已经有了进入域的第一把钥匙

- **利用哈希重用**：使用找到的哈希进行**哈希传递（Pass-the-Hash）**攻击
  - **工具**：`Metasploit` 的 `psexec` 模块或 `Impacket` 工具包中的 `psexec.py`
  - **命令**：`psexec.py <域>/<用户名>@<目标域机器IP> -hashes <哈希>`
  - **目的**：通过这个哈希，你可以尝试登录域内的其他机器，例如域成员服务器、其他域成员工作站，甚至是域控制器本身。如果这个用户是**域管理员**，那么你就直接成功了
- **破解哈希**：如果哈希无法直接利用（例如在 NTLMv2 认证环境中），你可以尝试离线破解这个哈希，获得明文密码
  - **工具**：`Hashcat` 或 `John the Ripper`
  - **目的**：一旦获得明文密码，你可以使用它进行传统的登录攻击，或者使用其他攻击工具进行横向移动